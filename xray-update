#!/bin/bash

# Function to install cron job
install_cron() {
    SCRIPT_URL="https://raw.githubusercontent.com/thejohnd0e/simple-xray-core/refs/heads/main/xray-update"
    CRON_JOB="0 3 * * * wget -qO- $SCRIPT_URL | bash >> /var/log/xray-update.log 2>&1"
    
    # Check if cron job already exists
    if crontab -l 2>/dev/null | grep -q "$SCRIPT_URL"; then
        echo "Cron job already installed."
        return 0
    fi
    
    # Add cron job
    (crontab -l 2>/dev/null; echo "$CRON_JOB") | crontab -
    echo "Cron job installed. Will check for updates daily at 3 AM."
    echo "Logs: /var/log/xray-update.log"
}

# Check for --install-cron flag
if [ "$1" == "--install-cron" ]; then
    install_cron
    exit 0
fi

# Get latest release version (without leading v)
LATEST=$(curl -s https://api.github.com/repos/XTLS/Xray-core/releases/latest \
    | grep tag_name | cut -d '"' -f4 | sed 's/^v//')

# Get currently installed version (without leading v)
CURRENT=$(/usr/local/bin/xray -version 2>/dev/null \
    | head -n1 | awk '{print $2}' | sed 's/^v//')

echo "Current version: $CURRENT"
echo "Latest version:  $LATEST"

# Determine if update is needed
if [ -z "$CURRENT" ]; then
    echo "Xray is not installed. Installing $LATEST..."
    NEED_UPDATE=1
elif [ "$LATEST" != "$CURRENT" ]; then
    echo "Update required."
    NEED_UPDATE=1
else
    echo "Already up to date."
    NEED_UPDATE=0
fi

# Perform update if needed
if [ $NEED_UPDATE -eq 1 ]; then
    systemctl stop xray
    wget https://github.com/XTLS/Xray-core/releases/download/v$LATEST/Xray-linux-64.zip -O /tmp/xray.zip
    unzip -o /tmp/xray.zip xray -d /usr/local/bin
    chmod +x /usr/local/bin/xray
    rm -f /tmp/xray.zip
    systemctl start xray
    echo "Updated to $LATEST"
fi
